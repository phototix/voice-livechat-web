<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>壹馨一意 🌻 真人交友 - 聊天室</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
    <style></style>
</head>
<body>
    <div class="chat-room" id="chat-room">
        <div class="header" id="room-title">
            壹馨一意 🌻 真人交友 - 聊天室
        </div>
        <div class="room-info">
            <img src="assets/host.png?version=1" alt="Host">
            <div class="sound-waves"></div>
            <h2>主持人 (房主)</h2>
            <p id="room-id">ID: 96844131</p>
        </div>
        <div class="user-slots">
            <!-- Active User Slots -->
            <div class="user-slot">
                <img src="assets/seat-1.png" alt="Seat-1">
                <span>虚位以待</span>
            </div>
            <div class="user-slot">
                <img src="assets/seat-2.png" alt="Seat-2">
                <span>虚位以待</span>
            </div>
            <div class="user-slot">
                <img src="assets/seat-3.png" alt="Seat-3">
                <span>虚位以待</span>
            </div>
            <div class="user-slot">
                <img src="assets/seat-4.png" alt="Seat-4">
                <span>虚位以待</span>
            </div>
            <div class="user-slot">
                <img src="assets/seat-5.png" alt="Seat-5">
                <span>虚位以待</span>
            </div>
            <!-- Empty Slots -->
            <div class="user-slot">
                <img src="assets/seat-6.png" alt="Seat-6">
                <span>虚位以待</span>
            </div>
            <div class="user-slot">
                <img src="assets/seat-7.png" alt="Seat-7">
                <span>虚位以待</span>
            </div>
            <div class="user-slot">
                <img src="assets/seat-boss.png" alt="Seat-boss">
                <span>老板</span>
            </div>
        </div>
        <!-- Chat History -->
        <div class="chat-history" id="chat-history">
        </div>
        <div class="footer">
            <div class="chat-box">
                <input type="text" placeholder="Type a message...">
            </div>
            <button class="button" id="mute-btn">
                <i class="fa fa-volume-up"></i>
            </button>
            <button class="button">
                <i class="fas fa-comment"></i>
            </button>
            <button class="button" id="open-modal-btn">
                <i class="fas fa-gift"></i>
            </button>
        </div>
    </div>

    <!-- Popup Dialog -->
    <div id="welcome-dialog" class="dialog">
        <div class="dialog-content">
        <h2>欢迎来到聊天室！</h2>
        <p><strong>聊天室详情：</strong></p>
        <ul>
            <li>由管理员进行管理</li>
            <li>鼓励友好的讨论</li>
            <li>尊重其他成员</li>
        </ul>
        <p><strong>聊天室规则：</strong></p>
        <ul>
            <li>禁止垃圾信息</li>
            <li>禁止使用攻击性语言</li>
            <li>禁止分享个人信息</li>
            <li>要友善且尊重他人</li>
        </ul>
        <button id="close-btn">确定</button>
        </div>
    </div>

    <!-- Gift Modal -->
    <div class="gift-modal" id="gift-modal">
        <div class="gift-modal-header">礼物</div>
        <span class="close-button" onclick="closeModal()">&times;</span> 
        <div class="gift-items">
            <div class="gift-item" data-gift="rose-1">
                <img src="assets/gifts/rose-1.png" alt="Rose">
                <div>玫瑰</div>
            </div>
            <div class="gift-item" data-gift="rose-2">
                <img src="assets/gifts/rose-1.png" alt="Rose">
                <div>玫瑰</div>
            </div>
            <div class="gift-item" data-gift="rose-3">
                <img src="assets/gifts/rose-1.png" alt="Rose">
                <div>玫瑰</div>
            </div>
        </div>
    </div>

    <!-- Gift Overlay -->
    <div class="gift-overlay" id="gift-overlay">
        <img src="" alt="Gift Effect">
    </div>
    
    <!-- Internet Radio -->
    <audio id="background-radio" autoplay loop>
        <source src="https://stream.zeno.fm/xiv7xayor3gvv" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Function to update the chat room UI based on JSON data
            function updateRoomStatus(data) {
                // Update host info
                const hostInfo = document.querySelector('.room-info');
                const timestamp = new Date().getTime();

                document.getElementById("room-id").innerText = `ID: ${data.room.id}`;
                document.getElementById("room-title").innerText = data.room.title;

                const chatRoom = document.querySelector(".chat-room");
                const style = document.createElement("style");
                style.innerHTML = `
                  .chat-room::before {
                    content: "";
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: url('${data.room.background}') no-repeat center center;
                    background-size: cover;
                    filter: brightness(0.5);
                    z-index: -1;
                  }
                `;
                document.head.appendChild(style);


                hostInfo.querySelector('img').src = data.host.photo;
                hostInfo.querySelector('h2').textContent = `${data.host.name} (房主)`;
                
                // Loop through each user slot and update the status
                const userSlots = document.querySelectorAll('.user-slot');
                const users = data.users;

                users.forEach((user, index) => {
                    const userSlot = userSlots[index];
                    const img = userSlot.querySelector('img');
                    const span = userSlot.querySelector('span');

                    // Update user slot based on user status
                    img.src = user.photo;
                    span.textContent = user.name;

                    // If the user is offline, mark the slot as "空" (empty)
                    if (user.status === "offline") {
                        span.textContent = "虚位以待";
                    }
                });
            }

            // Fetch the JSON data and update the UI
            function fetchRoomStatus() {
                fetch('room-status.json?timestamp=${timestamp}')
                    .then(response => response.json())
                    .then(data => {
                        updateRoomStatus(data);
                    })
                    .catch(error => {
                        console.error('Error loading room status:', error);
                    });
            }

            // Continuously update room status every 3 seconds
            setInterval(fetchRoomStatus, 3000);

            // Initial fetch to load the status when the page is loaded
            fetchRoomStatus();

            const timestamp = new Date().getTime();
            // Function to dynamically load the chat history from the JSON file
            function loadChatHistory() {
                fetch('chat-history.json?timestamp=${timestamp}')
                    .then(response => response.json())
                    .then(data => {
                        const chatHistoryContainer = document.getElementById('chat-history');
                        // Clear existing chat history (if any)
                        chatHistoryContainer.innerHTML = '';

                        // Loop through each message and add it to the chat history container
                        data.messages.forEach(messageData => {
                            const messageElement = document.createElement('div');
                            messageElement.classList.add('message');

                            const userSpan = document.createElement('span');
                            userSpan.textContent = `${messageData.user}:`;

                            const messagePara = document.createElement('p');
                            messagePara.textContent = messageData.message;

                            messageElement.appendChild(userSpan);
                            messageElement.appendChild(messagePara);

                            chatHistoryContainer.appendChild(messageElement);
                        });
                    })
                    .catch(error => {
                        console.error('Error loading chat history:', error);
                    });
            }

            // Load chat history when the page is loaded
            loadChatHistory();

            // Optionally, set an interval to reload the chat history periodically (e.g., every 5 seconds)
            setInterval(loadChatHistory, 5000);
        });


        // Mute/Unmute functionality
        const muteBtn = document.getElementById('mute-btn');
        const backgroundRadio = document.getElementById('background-radio');

        muteBtn.addEventListener('click', () => {
            if (backgroundRadio.muted) {
                backgroundRadio.muted = false;
                muteBtn.innerHTML = '<i class="fa fa-volume-up"></i>'; // Unmute Icon
            } else {
                backgroundRadio.muted = true;
                muteBtn.innerHTML = '<i class="fas fa-volume-mute"></i>'; // Mute Icon
            }
        });

        // Enable playback on user interaction
        const enablePlayback = () => {
            backgroundRadio.muted = false; // Unmute by default
            backgroundRadio.play().then(() => {
                console.log('Audio playback started.');
            }).catch((err) => {
                console.error('Playback failed:', err);
            });
            document.body.removeEventListener('click', enablePlayback); // Remove listener after activation
        };

        document.body.addEventListener('click', enablePlayback);

        // Modal and Overlay functionality
        const giftModal = document.getElementById('gift-modal');
        const giftOverlay = document.getElementById('gift-overlay');
        const giftItems = document.querySelectorAll('.gift-item');
        const openModalBtn = document.getElementById('open-modal-btn');
        const chatHistory = document.getElementById('chat-history');

        // Open modal
        openModalBtn.addEventListener('click', () => {
            giftModal.style.display = 'block';
        });

        // Select gift and show overlay
        giftItems.forEach(item => {
            item.addEventListener('click', () => {
                const giftName = item.dataset.gift;
                const giftEffectSrc = `assets/gifts/${giftName}.gif`;

                // Show overlay with selected gift
                giftOverlay.querySelector('img').src = giftEffectSrc;
                giftOverlay.style.display = 'flex';

                // Add gift message to chat
                const giftMessage = document.createElement('div');
                giftMessage.classList.add('message', 'gift');
                giftMessage.textContent = `您送了一个 ${giftName.charAt(0).toUpperCase() + giftName.slice(1)} 给主持人！`;
                chatHistory.appendChild(giftMessage);

                chatHistory.scrollTop = chatHistory.scrollHeight;

                // Hide modal
                giftModal.style.display = 'none';

                // Hide overlay after 3 seconds
                setTimeout(() => {
                    giftOverlay.style.display = 'none';
                }, 3000);
            });
        });

        // Function to close the gift modal
        function closeModal() {
            if (event.target === giftModal) {
                giftModal.style.display = 'none';
            }
        }

        // Close modal by clicking outside
        window.addEventListener('click', (event) => {
            if (event.target === giftModal) {
                giftModal.style.display = 'none';
            }
        });

        // Show the welcome dialog when the page loads
        window.onload = function() {
            document.getElementById('welcome-dialog').style.display = 'flex';
        }

        // Close the dialog when the "Okay" button is clicked
        document.getElementById('close-btn').addEventListener('click', function() {
            document.getElementById('welcome-dialog').style.display = 'none';
        });

        const audio = document.getElementById("background-radio");
        const hostAvatar = document.querySelector(".room-info .sound-waves");

        // Function to start/stop animation based on music playback
        function toggleSoundWaves() {
            if (!audio.paused && !audio.muted) {
                hostAvatar.style.display = "block"; // Show sound waves
            } else {
                hostAvatar.style.display = "none"; // Hide sound waves
            }
        }

        // Add event listeners
        audio.addEventListener("play", toggleSoundWaves);
        audio.addEventListener("pause", toggleSoundWaves);
        audio.addEventListener("volumechange", toggleSoundWaves);

        // Initialize state on load
        toggleSoundWaves();
    </script>

</body>
</html>
