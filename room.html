<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>凪卄的房间 🌻 聊天室</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script>
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'assets/css/style.css?version=' + new Date().getTime();
        document.head.appendChild(link);
    </script>
</head>
<body>
    <div class="chat-room" id="chat-room">
        <a href="/">
            <div class="header" id="room-title">
                凪卄的房间 🌻 聊天室
            </div>
        </a>
        <div class="room-info">
            <div class="host-avatar" onclick="openUserProfile()">
                <img src="assets/host.png?version=1" alt="Host">
                <div class="sound-waves-1"></div>
            </div>
            <h2>主持人 (房主)</h2>
            <p id="room-id">ID: 2004208</p>
        </div>
        <div class="user-slots">
            <!-- Active User Slots -->
            <div class="user-slot">
                <img src="assets/seat-1.png" alt="Seat-1">
                <span>虚位以待</span>
            </div>
            <div class="user-slot">
                <img src="assets/seat-2.png" alt="Seat-2">
                <span>虚位以待</span>
            </div>
            <div class="user-slot">
                <img src="assets/seat-3.png" alt="Seat-3">
                <span>虚位以待</span>
            </div>
            <div class="user-slot">
                <img src="assets/seat-4.png" alt="Seat-4">
                <span>虚位以待</span>
            </div>
            <div class="user-slot">
                <img src="assets/seat-5.png" alt="Seat-5">
                <span>虚位以待</span>
            </div>
            <!-- Empty Slots -->
            <div class="user-slot">
                <img src="assets/seat-6.png" alt="Seat-6">
                <span>虚位以待</span>
            </div>
            <div class="user-slot">
                <img src="assets/seat-7.png" alt="Seat-7">
                <span>虚位以待</span>
            </div>
            <div class="user-slot">
                <img src="assets/seat-boss.png" alt="Seat-boss">
                <span>老板</span>
            </div>
        </div>
        <!-- Chat History -->
        <div class="chat-history" id="chat-history">
        </div>
        <div class="footer">
            <div class="chat-box">
                <input type="text" placeholder="说点什么..." id="textInput">
            </div>
            <button class="button" onclick="sendMessage()">
                <i class="fa-regular fa-paper-plane"></i>
            </button>
            <audio id="audioPlayer" style="display: none;"></audio>
            <button class="button" id="mute-btn">
                <i class="fa fa-volume-up"></i>
            </button>
            <button class="button" onclick="gotoHome()">
                <i class="fas fa-home"></i>
            </button>
            <button class="button" id="open-modal-btn">
                <i class="fas fa-gift"></i>
            </button>
        </div>
    </div>

    <!-- Popup Dialog -->
    <div id="welcome-dialog" class="dialog">
        <div class="dialog-content">
        <h2>欢迎来到聊天室！</h2>
        <p><strong>聊天室详情：</strong></p>
        <ul>
            <li>由管理员进行管理</li>
            <li>鼓励友好的讨论</li>
            <li>尊重其他成员</li>
        </ul>
        <p><strong>聊天室规则：</strong></p>
        <ul>
            <li>禁止垃圾信息</li>
            <li>禁止使用攻击性语言</li>
            <li>禁止分享个人信息</li>
            <li>要友善且尊重他人</li>
        </ul>
        <button id="close-btn">确定</button>
        </div>
    </div>

    <!-- Gift Modal -->
    <div class="gift-modal" id="gift-modal">
        <div class="gift-modal-header">礼物</div>
        <span class="close-button" onclick="closeModal()">&times;</span> 
        <div class="gift-items" id="gift-items">
            <div class="gift-item" data-gift="rose-1" data-name="玫瑰" data-duration="1500">
                <img src="assets/gifts/rose-1.png" alt="Rose">
                <div>玫瑰</div>
            </div>
            <div class="gift-item" data-gift="castle-01" data-name="城堡" data-duration="3500">
                <img src="assets/gifts/castle-01.png" alt="Castle">
                <div>城堡</div>
            </div>
            <div class="gift-item" data-gift="ship-01" data-name="游轮" data-duration="4000">
                <img src="assets/gifts/ship-01.png" alt="Ship">
                <div>游轮</div>
            </div>
            <div class="gift-item" data-gift="rocket-01" data-name="火箭" data-duration="4000">
                <img src="assets/gifts/rocket-01.png" alt="Rocket">
                <div>火箭</div>
            </div>
        </div>
    </div>

    <!-- Gift Overlay -->
    <div class="gift-overlay" id="gift-overlay">
        <img src="" alt="Gift Effect">
    </div>
    
    <!-- Internet Radio -->
    <audio id="background-radio" autoplay loop>
        <source id="audio-source" src="#" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>
    <input type="hidden" id="radio_url">

    <!-- User Profile Modal -->
    <div class="user-profile-modal" id="user-profile-modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeUserProfile()">&times;</span>
            <div class="user-info">
                <img src="assets/yishao-profile.png" id="host-profile-image" alt="Host Avatar">
                <h2 id="host-profile-name">壹韶</h2>
                <!-- Add more user info as needed -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Function to get query parameter by name
            function getQueryParam(name) {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get(name);
            }
            
            // Function to update the chat room UI based on JSON data
            function updateRoomStatus(data) {
                // Update host info
                const hostInfo = document.querySelector('.room-info');
                const timestamp = new Date().getTime();

                document.getElementById("room-id").innerText = `ID: ${data.room.id}`;
                document.getElementById("room-title").innerText = data.room.title;
                document.getElementById("audio-source").src = data.room.radioURL;
                document.getElementById("radio_url").src = data.room.radioURL;

                console.log("RadioURL:" + data.room.radioURL);

                document.getElementById("host-profile-image").src = data.host.photo;
                document.getElementById("host-profile-name").innerText = `${data.host.name} (主持人)`;

                const chatRoom = document.querySelector(".chat-room");
                const style = document.createElement("style");
                style.innerHTML = `
                  .chat-room::before {
                    content: "";
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: url('${data.room.background}') no-repeat center center;
                    background-size: cover;
                    filter: brightness(0.5);
                    z-index: -1;
                  }
                `;
                document.head.appendChild(style);


                hostInfo.querySelector('img').src = data.host.photo;
                hostInfo.querySelector('h2').textContent = `${data.host.name} (主持人)`;
                
                // Loop through each user slot and update the status
                const userSlots = document.querySelectorAll('.user-slot');
                const users = data.users;

                users.forEach((user, index) => {
                    const userSlot = userSlots[index];
                    const img = userSlot.querySelector('img');
                    const span = userSlot.querySelector('span');

                    userSlot.setAttribute('data-userid', user.userid);

                    // Update user slot based on user status
                    img.src = user.photo;
                    span.textContent = user.name;

                    // If the user is offline, mark the slot as "空" (empty)
                    if (user.status === "offline") {
                        span.textContent = "虚位以待";
                    }
                });
            }

            // Fetch the JSON data and update the UI
            function fetchRoomStatus() {
                const timestamp = new Date().getTime();
                const id = getQueryParam('id');
                fetch(`cache/${id}-room-status.json?timestamp=${timestamp}`)  // Use backticks here
                    .then(response => response.json())
                    .then(data => {
                        updateRoomStatus(data);
                    })
                    .catch(error => {
                        console.error('Error loading room status:', error);
                    });

                console.log(`Room Status updated. Timestamp: ${timestamp}`);  // Use backticks here as well
            }

            // Continuously update room status every 3 seconds
            setInterval(fetchRoomStatus, 3000);

            // Initial fetch to load the status when the page is loaded
            fetchRoomStatus();

            
            // Function to dynamically load the chat history from the JSON file
            function loadChatHistory() {
                const timestamp = new Date().getTime();
                const id = getQueryParam('id');
                fetch(`cache/${id}-chat-history.json?timestamp=${timestamp}`)
                    .then(response => response.json())
                    .then(data => {
                        const chatHistoryContainer = document.getElementById('chat-history');
                        // Clear existing chat history (if any)
                        chatHistoryContainer.innerHTML = '';

                        // Loop through each message and add it to the chat history container
                        data.messages.forEach(messageData => {
                            const messageElement = document.createElement('div');
                            messageElement.classList.add('message');

                            const userSpan = document.createElement('span');
                            userSpan.textContent = `${messageData.user}:`;

                            const messagePara = document.createElement('p');
                            messagePara.textContent = messageData.message;

                            messageElement.appendChild(userSpan);
                            messageElement.appendChild(messagePara);

                            chatHistoryContainer.appendChild(messageElement);
                        });
                    })
                    .catch(error => {
                        console.error('Error loading chat history:', error);
                    });
            }

            // Load chat history when the page is loaded
            loadChatHistory();
            
        });


        // Mute/Unmute functionality
        const muteBtn = document.getElementById('mute-btn');
        const backgroundRadio = document.getElementById('background-radio');
        const backgroundRadioURL = document.getElementById("radio_url").value;

        muteBtn.addEventListener('click', () => {
            if (backgroundRadio.muted) {
                backgroundRadio.muted = false;
                muteBtn.innerHTML = '<i class="fa fa-volume-up"></i>'; // Unmute Icon
            } else {
                backgroundRadio.muted = true;
                muteBtn.innerHTML = '<i class="fas fa-volume-mute"></i>'; // Mute Icon
            }
        });

        // Enable playback on user interaction
        const enablePlayback = () => {
            backgroundRadio.muted = false; // Unmute by default
            backgroundRadio.play().then(() => {
                console.log('Audio playback started.');
            }).catch((err) => {
                console.error('Playback failed:', err);
                tryFallbackURL();
            });
            document.body.removeEventListener('click', enablePlayback); // Remove listener after activation
        };

        document.body.addEventListener('click', enablePlayback);

        // Function to handle fallback to the hidden input URL
        const tryFallbackURL = () => {
            const newURL = backgroundRadioURL.value; // Get the URL from the hidden input
            const audioSource = document.getElementById('audio-source');

            if (newURL) {
                console.log('Attempting fallback URL:', newURL);
                audioSource.src = newURL; // Update source URL
                backgroundRadio.load(); // Reload the audio element
                backgroundRadio.play().then(() => {
                    console.log('Fallback URL playback started.');
                }).catch((err) => {
                    console.error('Fallback playback failed:', err);
                });
            } else {
                console.error('No fallback URL provided.');
            }
        };

        // Modal and Overlay functionality
        const giftModal = document.getElementById('gift-modal');
        const giftOverlay = document.getElementById('gift-overlay');
        const giftItems = document.querySelectorAll('.gift-item');
        const openModalBtn = document.getElementById('open-modal-btn');
        const chatHistory = document.getElementById('chat-history');

        // Open modal
        openModalBtn.addEventListener('click', () => {
            giftModal.style.display = 'block';
        });

        // Select gift and show overlay
        giftItems.forEach(item => {
            item.addEventListener('click', async () => {
                const giftName = item.dataset.gift;
                const giftDisplay = item.dataset.name;
                const giftDuration = item.dataset.duration;
                const giftEffectSrc = `assets/gifts/${giftName}.gif`;

                // Show overlay with selected gift
                giftOverlay.querySelector('img').src = giftEffectSrc;
                giftOverlay.style.display = 'flex';

                // Add gift message to chat
                const giftMessage = document.createElement('div');
                giftMessage.classList.add('message', 'gift');
                giftMessage.textContent = `您送了一个 ${giftDisplay} 给主持人！`;
                chatHistory.appendChild(giftMessage);

                chatHistory.scrollTop = chatHistory.scrollHeight;

                // Hide modal
                giftModal.style.display = 'none';

                // Send gift message to the webhook
                try {
                    const webhookUrl = "https://workflows.brandon.my/webhook/30bf5fd9-8eea-4f67-8b3a-a3f41cbbe6a9";
                    const text = `游客送你了一个 "${giftDisplay}" 礼物！`;

                    const response = await fetch(webhookUrl, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ text })
                    });

                    if (!response.ok) {
                        throw new Error(`Webhook error: ${response.statusText}`);
                    }

                    // Parse the binary response
                    const blob = await response.blob();

                    // Create a temporary URL for the binary audio
                    const audioUrl = URL.createObjectURL(blob);

                    // Lower radio volume to 20%
                    const radio = document.getElementById("background-radio");
                    radio.volume = 0.15;

                    // Play the returned audio
                    const speechAudio = document.getElementById("audioPlayer");
                    speechAudio.src = audioUrl;
                    speechAudio.style.display = "block";
                    speechAudio.play();

                    // Restore radio volume when audio ends
                    speechAudio.onended = () => {
                        radio.volume = 1.0; // Restore to 100%
                    };

                    console.log("Gift message sent and audio played successfully.");
                } catch (error) {
                    console.error("Error sending gift message or playing audio:", error);
                }

                // Hide overlay after specified duration
                setTimeout(() => {
                    giftOverlay.style.display = 'none';
                }, giftDuration);
            });
        });

        function gotoHome(){
            window.location="/";
        }

        // Function to close the gift modal
        function closeModal() {
            if (event.target === giftModal) {
                giftModal.style.display = 'none';
            }
        }

        // Close modal by clicking outside
        window.addEventListener('click', (event) => {
            if (event.target === giftModal) {
                giftModal.style.display = 'none';
            }
        });

        // Show the welcome dialog when the page loads
        window.onload = function() {
            document.getElementById('welcome-dialog').style.display = 'flex';
        }

        // Close the dialog when the "Okay" button is clicked
        document.getElementById('close-btn').addEventListener('click', function() {
            document.getElementById('welcome-dialog').style.display = 'none';
        });

        const audio = document.getElementById("background-radio");
        const hostAvatar = document.querySelector(".room-info .sound-waves-1");

        // Function to start/stop animation based on music playback
        function toggleSoundWaves() {
            if (!audio.paused && !audio.muted) {
                hostAvatar.style.display = "block"; // Show sound waves
            } else {
                hostAvatar.style.display = "none"; // Hide sound waves
            }
        }

        // Add event listeners
        audio.addEventListener("play", toggleSoundWaves);
        audio.addEventListener("pause", toggleSoundWaves);
        audio.addEventListener("volumechange", toggleSoundWaves);

        // Initialize state on load
        toggleSoundWaves();

        // Function to open the user profile modal
        function openUserProfile() {
            document.getElementById("user-profile-modal").style.display = "block";
        }

        // Function to close the user profile modal
        function closeUserProfile() {
            document.getElementById("user-profile-modal").style.display = "none";
        }

        // Close the modal if clicked outside the modal content
        window.onclick = function(event) {
            if (event.target === document.getElementById("user-profile-modal")) {
                closeUserProfile();
            }
        }

        async function sendMessage() {
            const textInput = document.getElementById("textInput");
            const message = textInput.value.trim();
            const radio = document.getElementById("background-radio");
            const speechAudio = document.getElementById("audioPlayer");
            const chatHistory = document.getElementById("chat-history");

            if (!message) {
                console.log("Please enter a message.");
                return;
            }

            // Append user input to chat history
            const messageDiv = document.createElement("div");
            messageDiv.classList.add("message");
            messageDiv.innerHTML = `<span>游客:</span><p>${message}</p>`;
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight; // Auto-scroll to the latest message
            textInput.value = ""; // Clear the input

            try {
                // Define the n8n webhook URL
                const webhookUrl = "https://workflows.brandon.my/webhook/30bf5fd9-8eea-4f67-8b3a-a3f41cbbe6a9";

                // Send text to the webhook
                const response = await fetch(webhookUrl, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ text: message })
                });

                if (!response.ok) {
                    throw new Error(`Webhook error: ${response.statusText}`);
                }

                // Parse the binary response
                const blob = await response.blob();

                // Create a temporary URL for the binary audio
                const audioUrl = URL.createObjectURL(blob);

                // Play the speech audio
                speechAudio.src = audioUrl;
                speechAudio.style.display = "block";

                // Lower radio volume to 20%
                radio.volume = 0.15;

                // Play speech audio and restore radio volume when it ends
                speechAudio.play();
                speechAudio.onended = () => {
                    radio.volume = 1.0; // Restore to 100%
                };

            } catch (error) {
                console.error("Error:", error);
            }
        }

        // Event listener for the "Enter" key or "Send" button
        document.getElementById("textInput").addEventListener("keydown", (event) => {
            if (event.key === "Enter") {
                event.preventDefault(); // Prevent default form submission
                sendMessage();
            }
        });

    </script>

</body>
</html>
